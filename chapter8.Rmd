--- 
title       : "Experiments 8: Noncompliance2"
description : "These videos and exercises discuss the issue of noncompliance in experiments."

--- type:VideoExercise lang:r aspect_ratio:62.5 xp:50 skills:1 key:db0bf3e371
## Survey Noncompliance
*** =video_link
//player.vimeo.com/video/198212102


--- type:MultipleChoiceExercise lang:r xp:50 skills:1 key:
  ## Offering a Higher Credit Card Limit: Quantifying Noncompliance Concerns
  CreditCo, a large credit card company, decides to run an experiment. It sends an offer in the mail to a random group of 50% of its customers: those in the treatment group are invited to navigate to a webpage and opt in for a 10% higher credit limit. CreditCo wants to see how credit balances and late payments are impacted six months later as a result of the experiment. 

Suppose that, of the group that received the mail offer, 40% of people opted in. Do you think that noncompliance will be a problem for CreditCo's analysis? Why or why not?

*** =instructions
- No, because people in the treatment group likely used a coin flip to make their opt-in decision.
- Yes, because the opt-in rate is low.
- No, because an opt-in rate of 40% is actually quite high.
- Yes, because the set of people opting in are probably people with worse spending habits.

*** =sct
```{r}
msg1 = "While this is a possibility, it is unlikely to actually be the case. Try again."
msg2 = "This is partially correct. A low compliance rate is one symptom of a noncompliance problem."
msg3 = "While high compliance rates indicate a lower noncompliance problem, the rate of 40% in this situation is likely to be problematic."
msg4 = "Correct! In this situation, researchers at CreditCo should be worried about the spending habits of those who opted in to the offer."
test_mc(correct = 4, feedback_msgs = c(msg1,msg2,msg3,msg4))
```


---
## Let's Code: Working with Noncompliance
```yaml
type: VideoExercise
lang: r
xp: 50
skills: 1
key: f6472f88d4
video_link: //player.vimeo.com/video/279737627
```

--- type:NormalExercise lang:r xp:100 skills:1 key:
  ## Offering a Higher Credit Card Limit: Working with Noncompliance
  Let's continue with the CreditCo dataset described in the previous exercise. The CFO has assigned you to figure out the average treatment effect of taking a credit line increase offer on late payments (`default_post`), and he wants to see something before lunch. You realize that you can give him a simple result: you just need to do some quick checks for balance in your samples and compute a "naive" average treatment effect to get the analysis started.

A simulated version of this dataset, `CreditCo`, is available in the workspace.  With that data:

*** =instructions
- 1) See if treatment and control groups (`offered`) are of equal size.
- 2) Compute the fraction of people who opted in (`opt_in`) to the credit offer.
- 3) Compute a naive average treatment effect on late payments (`default_post`).

*** =hint
- When a variable's values are binary (0 or 1), you can compute the proportion of 1s by simply taking the mean of the variable.
- Remember to select the appropriate sample when computing the opt-in rate of the credit offer.


*** =pre_exercise_code
```{r}
library(data.table)
library(dplyr)

set.seed(1)
n             <- 9e3
frac_treated  <- .5
frac_female   <- .5656
frac_white    <- .688

# Initialize dataframe
CreditCo <- as.data.frame(matrix(0, ncol=11,nrow=n))
colnames(CreditCo) <- c("id","offered","opt_in","FICO","age","female","race_white","default_pre","default_post","balance_pre","balance_post")

# Simulate baseline data
CreditCo$id         <- seq(1,n,1)
CreditCo$offered    <- as.integer(runif(n)<frac_treated)
CreditCo$opt_in     <- rep.int(0,n)
CreditCo$FICO       <- rnorm(n, mean=736, sd=300)
CreditCo$age        <- sample(18:55, n, replace=T)
CreditCo$female     <- as.integer(runif(n)<frac_female)
CreditCo$race_white <- as.integer(runif(n)<frac_white)

# make FICO score intelligible
CreditCo$FICO[CreditCo$FICO>850] <- 850
CreditCo$FICO[CreditCo$FICO<300] <- 300
CreditCo$FICO                    <- round(CreditCo$FICO)

# simulate pre-experiment default rate
draw <- runif(n)
xb   <- -1.82-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-5.1*CreditCo$female-7*CreditCo$race_white
p    <- exp(xb)/(1+exp(xb))
CreditCo$default_pre <- as.integer(draw<p)

# simulate pre-experiment balance level
draw <- rnorm(n, mean=0, sd=0.5)
CreditCo$balance_pre <- 8.5-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-0.15*CreditCo$female-0.85*CreditCo$race_white + draw
CreditCo$balance_pre <- exp(CreditCo$balance_pre)

# Simulate noncompliance and opt-in behavior
draw <- runif(sum(CreditCo$offered))
xb   <- 6.75-1.2*CreditCo$FICO/100+.07*(CreditCo$FICO^2)/10000-2.1*CreditCo$female-2*CreditCo$race_white
p    <- exp(xb)/(1+exp(xb))
CreditCo$opt_in[CreditCo$offered==1] <- as.integer(draw<p[CreditCo$offered==1])

# Simulate post outcomes
draw <- runif(n)
xb   <- -1.82-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-5.1*CreditCo$female-7*CreditCo$race_white+4*CreditCo$offered*CreditCo$opt_in
p    <- exp(xb)/(1+exp(xb))
CreditCo$default_post <- as.integer(draw<p)

# balance
draw <- rnorm(n, mean=0, sd=0.5)
CreditCo$balance_post <- 8.5-0.2*CreditCo$FICO/100+.046*(CreditCo$FICO^2)/10000-0.15*CreditCo$female-0.85*CreditCo$race_white + 1*CreditCo$offered*CreditCo$opt_in + draw
CreditCo$balance_post <- exp(CreditCo$balance_post)

# Remove elements and variables from environment
rm(draw,frac_female,frac_treated,frac_white,n,p,xb)
CreditCo <- CreditCo[,c("id","offered","opt_in","FICO","female","race_white","default_pre","default_post","balance_pre","balance_post")]
```

*** =sample_code
```{r}
# The dataset `CreditCo` is available in your workspace. You may want to explore it with the structure "str" command before solving the following questions.

# 1) Using the mean command, compute the percentage of people who were offered a higher credit limit. 
mean()

# 2) Of the people who were offered, what percentage opted in? 
Solution2<- mean()

# 3) Compute a naive average treatment effect of late payment (variable `default_post`), where treatment state is defined by having been offered **and** opted in to the program. 
Solution3<- mean()

```

*** =solution
```{r}
#1
mean(CreditCo$offered)
#2
Solution2<-mean(CreditCo$opt_in[CreditCo$offered==1])
#3
Solution3<-mean(CreditCo$default_post[CreditCo$opt_in==1])-mean(CreditCo$default_post[CreditCo$offered==0])
```

*** =sct
```{r}
test_object("Solution2")
test_object("Solution3")
test_error()
success_msg("Nice job! As you can see, about half of the sample received an offer, but only about 41% of people actually accepted it. For the people who complied, the 'naive' treatment effect is a +26% default rate--the default rate went up for people who accepted the offer! However, while this 'naive' ATE is quick to calculate, it's probably not accurate, as there are likely confounders that we can deal with when we have more time.")
```
